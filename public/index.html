<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Panjer</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; padding: 15px; background: #f4f4f9; }
        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 15px; }
        input:disabled { background: #eee; }
        .upload-card { background: #fff; padding: 10px; border: 1px dashed #0088cc; border-radius: 8px; margin-bottom: 10px; }
        button { width: 100%; padding: 12px; background: #0088cc; color: #fff; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <form id="panjerForm">
        <div class="form-group"><label>Tanggal Nota</label><input type="date" id="tanggal" required></div>
        
        <div class="form-group">
            <label>Jenis Pekerjaan</label>
            <select id="jenis" onchange="toggleKBM()" required>
                <option value="">-- Pilih --</option>
                <option value="BBM KBM R4">BBM KBM R4</option>
                <option value="BBM KBM R2">BBM KBM R2</option>
                <option value="PANTRI">PANTRI</option>
                <option value="MATERIAL">MATERIAL</option>
                <option value="JASA">JASA</option>
            </select>
        </div>

        <div class="form-group">
            <label>TIM</label>
            <select id="tim" class="kbm-field" disabled required>
                <option value="">-- Pilih TIM --</option>
                <option value="MAINTENANCE">MAINTENANCE</option>
                <option value="B2B">B2B</option>
            </select>
        </div>

        <div class="form-group">
            <label>KM (Awal & Akhir)</label>
            <div style="display:flex; gap:5px;"><input type="number" id="kmAwal" class="kbm-field" placeholder="Awal" disabled> <input type="number" id="kmAkhir" class="kbm-field" placeholder="Akhir" disabled></div>
        </div>

        <div class="form-group"><label>PLAT</label><input type="text" id="plat" class="kbm-field" placeholder="L 1234 XX" disabled></div>

        <div class="upload-card"><label>ðŸ“¸ KM Awal</label><input type="file" id="imgKmAwal" class="kbm-field" accept="image/*" disabled></div>
        <div class="upload-card"><label>ðŸ“¸ KM Akhir</label><input type="file" id="imgKmAkhir" class="kbm-field" accept="image/*" disabled></div>
        <div class="upload-card"><label>ðŸ“¸ Nota (Wajib)</label><input type="file" id="imgNota" accept="image/*" required></div>
        <div class="upload-card"><label>ðŸ“¸ Evidence (Wajib)</label><input type="file" id="imgEvidence" accept="image/*" required></div>

        <div class="form-group"><label>Uraian</label><textarea id="uraian" rows="2" required></textarea></div>
        <div class="form-group"><label>Jumlah Rp</label><input type="number" id="jumlah" required></div>

        <button type="submit" id="btnSubmit">KIRIM LAPORAN</button>
    </form>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        function toggleKBM(){
            const isKBM = document.getElementById('jenis').value.includes("KBM");
            document.querySelectorAll('.kbm-field').forEach(f => {
                f.disabled = !isKBM; f.required = isKBM;
                f.style.background = isKBM ? "#fff" : "#eee";
                if(!isKBM) f.value = "";
            });
        }
        const toBase64 = f => !f ? null : new Promise((res,rej)=>{
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]);
        });

        document.getElementById('panjerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.innerText = "Proses..."; btn.disabled = true;
            
            const formData = {
                telegramId: tg.initDataUnsafe.user?.id || "92250027",
                tanggal: document.getElementById('tanggal').value,
                jenis: document.getElementById('jenis').value,
                tim: document.getElementById('tim').value || "",
                plat: document.getElementById('plat').value || "",
                kmAwal: document.getElementById('kmAwal').value || "",
                kmAkhir: document.getElementById('kmAkhir').value || "",
                uraian: document.getElementById('uraian').value,
                jumlah: document.getElementById('jumlah').value,
                fileKmAwal: await toBase64(document.getElementById('imgKmAwal').files[0]),
                fileKmAkhir: await toBase64(document.getElementById('imgKmAkhir').files[0]),
                fileNota: await toBase64(document.getElementById('imgNota').files[0]),
                fileEvidence: await toBase64(document.getElementById('imgEvidence').files[0])
            };

            const res = await fetch('/webhook', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type:"SUBMIT_FORM", formData}) });
            const result = await res.json();
            if(result.status === "success") tg.showAlert(`Sukses! ID: ${result.uniqueId}`, () => tg.close());
        });
    </script>
</body>
</html>
